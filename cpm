#!/bin/sh -e

umask 077
CPM_PASSWORD_DIR=${CPM_PASSWORD_DIR:-${XDG_CONFIG_HOME:-$HOME/.config}/cpm}
CPM_MASTER_NAME=${CPM_MASTER_NAME:-default}
CPM_CACHE_DIR=${PASSWORD_CACHE_FILE:-/tmp/.cpm/$USER/}
CPM_CACHE_FILE="$CPM_CACHE_DIR/$CPM_MASTER_NAME"

usage() {
    echo "$0 show name"
    echo "$0 insert name"
    exit "$1"
}

get_pass() {
    mkdir -p "$(dirname "$CPM_CACHE_FILE")"
    printf "Enter password:" >&2
    if [ -t 0 ]; then
       stty -echo
    fi
    read -r PASS
    printf "%s" "$PASS"
    if [ -t 0 ]; then
        stty echo
    fi
}

case "$1" in
    lock)
        [ -e "$CPM_CACHE_FILE" ] && rm "$CPM_CACHE_FILE"
        ;;
    unlock)
        [ -d "$CPM_CACHE_DIR" ] || mkdir -p "$CPM_CACHE_DIR"
        get_pass > "$CPM_CACHE_FILE"
        ;;
    klock)
        keyctl purge user "$CPM_MASTER_NAME"
        ;;
    kunlock)
        get_pass | keyctl padd user "$CPM_MASTER_NAME" @u >/dev/null 2>&1
        ;;
    show)
        [ -e "$CPM_PASSWORD_DIR/$2" ] || usage 2
        if keyctl request user "$CPM_MASTER_NAME" >/dev/null 2>&1 ; then
            keyctl pipe "$(keyctl request user "$CPM_MASTER_NAME")" | ccrypt "$CPM_PASSWORD_DIR/$2"
        elif [ -r "$CPM_CACHE_FILE" ]; then
            ccrypt -c -k "$CPM_CACHE_FILE" "$CPM_PASSWORD_DIR/$2"
        else
            PASS=$(get_pass)
            printf "%s" "$PASS" | ccrypt "$CPM_PASSWORD_DIR/$2"
            printf "%s" "$PASS" | keyctl padd user "$CPM_MASTER_NAME" @u >/dev/null 2>&1 || true
            [ -n "$CPM_TIMEOUT" ] && keyctl timeout "$(keyctl request user "$CPM_MASTER_NAME")" "$CPM_TIMEOUT"
        fi
        ;;
    insert)
        PASS_FILE="$CPM_PASSWORD_DIR/$2"
        DIR=${PASS_FILE%/*}
        [ -e "$DIR" ] || mkdir -p "$DIR"
        {
            if [ -r "$CPM_CACHE_FILE" ]; then
                ccrypt -e -k "$CPM_CACHE_FILE"
            else
                ccrypt -e
            fi
        } > "$PASS_FILE"
        ;;
    -h|--help|help)
        usage 0
        ;;
    *)
        usage 2
        ;;
esac
